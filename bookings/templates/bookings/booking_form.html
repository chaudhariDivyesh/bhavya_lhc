{% extends 'base.html' %}

{% block title %}LHC Booking Form{% endblock %}

{% block content %}
<h2>Book a Lecture Hall</h2>

<!-- Display form errors if any -->
{% if form.errors %}
    <div class="alert alert-danger">
        <strong>Errors:</strong>
        <ul>
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                    <li>{{ field|title }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
{% endif %}

<!-- Booking form -->
<form method="post">
    {% csrf_token %}

    <div>
        <label for="id_lecture_hall">Select Lecture Hall:</label>
        {{ form.lecture_hall }}
    </div>

    <div>
        <label for="id_date">Select Date:</label>
        <input type="date" name="date" id="id_date">
    </div>

    <div>
        <label>Select Time Slots:</label>
        <div id="time_slots_container">
            {% for slot in form.time_slots %}
                <div>
                    {{ slot.tag }} {{ slot.choice_label }}
                </div>
            {% endfor %}
        </div>
    </div>

    <button type="submit">Submit Booking</button>
</form>

<script>
    document.getElementById('id_lecture_hall').addEventListener('change', fetchAvailableSlots);
    document.getElementById('id_date').addEventListener('change', fetchAvailableSlots);

    function fetchAvailableSlots() {
        const hallId = document.getElementById('id_lecture_hall').value;
        const date = document.getElementById('id_date').value;

        if (hallId && date) {
            fetch(`/bookings/get_available_slots/?lecture_hall=${hallId}&date=${date}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('time_slots_container');
                    container.innerHTML = "";
                    data.forEach(slot => {
                        const slotLabel = `${slot.start_time} - ${slot.end_time}`; // Correcting the label
                        const checkbox = `<div>
                            <input type="checkbox" name="time_slots" value="${slot.id}" id="slot_${slot.id}">
                            <label for="slot_${slot.id}">${slotLabel}</label>
                        </div>`;
                        container.innerHTML += checkbox;
                    });
                })
                .catch(error => console.error("Error fetching time slots:", error));
        }
    }
</script>
{% endblock %}
